name: Code Coverage

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Debug
  LLVM_VERSION: 15

jobs:
  coverage:
    name: Generate Code Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            llvm-${{ env.LLVM_VERSION }}-dev \
            libclang-${{ env.LLVM_VERSION }}-dev \
            clang-${{ env.LLVM_VERSION }} \
            lcov \
            gcovr

      - name: Setup LLVM environment
        run: |
          echo "LLVM_DIR=/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake/llvm" >> $GITHUB_ENV
          echo "Clang_DIR=/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake/clang" >> $GITHUB_ENV
          echo "/usr/lib/llvm-${{ env.LLVM_VERSION }}/bin" >> $GITHUB_PATH

      - name: Cache LLVM/Clang
        uses: actions/cache@v4
        with:
          path: |
            /usr/lib/llvm-${{ env.LLVM_VERSION }}
          key: ${{ runner.os }}-llvm-${{ env.LLVM_VERSION }}-coverage

      - name: Configure CMake with coverage
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DENABLE_COVERAGE=ON \
            -DLLVM_DIR=${{ env.LLVM_DIR }} \
            -DClang_DIR=${{ env.Clang_DIR }}

      - name: Build project
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel $(nproc)

      - name: Run all tests for coverage
        run: |
          cd build

          # Initialize coverage data
          lcov --directory . --zerocounters

          # Run all test executables
          TEST_EXECUTABLES=$(find . -maxdepth 1 -name "*Test" -type f -executable)

          echo "Running tests for coverage..."
          FAILED_TESTS=()
          PASSED_TESTS=0

          for test in $TEST_EXECUTABLES; do
            TEST_NAME=$(basename "$test")
            echo "Running $TEST_NAME..."
            if "$test"; then
              echo "✓ $TEST_NAME PASSED"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "✗ $TEST_NAME FAILED (continuing for coverage)"
              FAILED_TESTS+=("$TEST_NAME")
            fi
          done

          echo ""
          echo "Tests completed: $PASSED_TESTS passed, ${#FAILED_TESTS[@]} failed"

      - name: Generate coverage report
        run: |
          cd build

          # Capture coverage data
          lcov --directory . --capture --output-file coverage.info

          # Remove system headers and test files
          lcov --remove coverage.info \
            '/usr/*' \
            '*/tests/*' \
            --output-file coverage.info.cleaned

          # Generate HTML report
          genhtml coverage.info.cleaned \
            --output-directory coverage-html \
            --demangle-cpp \
            --title "C++ to C Transpiler Coverage" \
            --legend \
            --show-details

          # Generate summary
          lcov --list coverage.info.cleaned > coverage-summary.txt

          # Print summary
          echo "======================================"
          echo "Coverage Summary"
          echo "======================================"
          cat coverage-summary.txt

      - name: Generate coverage report for codecov
        run: |
          cd build
          # Generate XML format for codecov
          gcovr --xml-pretty --exclude-unreachable-branches \
            --print-summary -o coverage.xml \
            --root .. \
            --exclude '../tests/.*' \
            --exclude '../build/.*' \
            .

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: build/coverage-html/
          retention-days: 30

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data
          path: |
            build/coverage.info.cleaned
            build/coverage.xml
            build/coverage-summary.txt
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summaryFile = 'build/coverage-summary.txt';

            if (fs.existsSync(summaryFile)) {
              const summary = fs.readFileSync(summaryFile, 'utf8');

              // Extract overall coverage percentage
              const match = summary.match(/lines\.*:\s*(\d+\.\d+)%/);
              const coverage = match ? match[1] : 'N/A';

              const commentBody = `## Code Coverage Report\n\n` +
                `**Overall Line Coverage:** ${coverage}%\n\n` +
                `<details>\n<summary>Coverage Details</summary>\n\n` +
                `\`\`\`\n${summary}\n\`\`\`\n\n</details>\n\n` +
                `Full HTML report available in artifacts.\n\n` +
                `---\n*Automated coverage report by GitHub Actions*`;

              // Find existing comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('## Code Coverage Report')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody,
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody,
                });
              }
            }

      - name: Generate job summary
        if: always()
        run: |
          echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f build/coverage-summary.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat build/coverage-summary.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report generation failed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Tool:** lcov + gcovr" >> $GITHUB_STEP_SUMMARY

      - name: Check coverage threshold
        run: |
          cd build

          # Extract line coverage percentage
          COVERAGE=$(lcov --summary coverage.info.cleaned 2>&1 | grep "lines" | grep -oP '\d+\.\d+(?=%)')

          echo "Coverage: ${COVERAGE}%"

          # Set minimum coverage threshold (adjust as needed)
          THRESHOLD=70.0

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "⚠️ Warning: Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            # Don't fail the build, just warn
          else
            echo "✅ Coverage ${COVERAGE}% meets or exceeds threshold ${THRESHOLD}%"
          fi
