# Phase 41-01: Global Variables & Types Implementation

**Phase**: 41 (Phase 3 in Architecture)
**Goal**: Add support for global variables, static local variables, string/char literals, arrays, and type casting
**Approach**: Test-Driven Development (TDD) with extensive parallelization
**Duration**: Est. 12-15 hours

---

## Objective

Extend the transpiler to handle global variables, storage classes, string/character literals, basic arrays, and type casts. This completes the foundational C functionality, enabling programs with global state and array manipulation.

## Context

**Previous Phases:**
- Phase 39 (Phase 1): Basic functions, arithmetic, local variables ✅
- Phase 40 (Phase 2): Control flow (if/while/for/switch) ✅

**Current State:**
- Handlers exist: FunctionHandler, VariableHandler, ExpressionHandler, StatementHandler
- Test infrastructure: Unit, integration, E2E test frameworks in place
- 232 tests passing (99.1% pass rate)

**Phase 3 Scope (from docs/architecture/05-implementation-phases.md):**
- Global variable declarations and definitions
- Static local variables
- String literals (`const char*`)
- Character literals
- Type casts (C-style and implicit)
- Const qualifiers on variables
- Array types and array subscript (`arr[i]`)
- Array initialization with `InitListExpr`

**Architecture:**
- 1:1 C mapping for all constructs (no transformations)
- Direct opcode/syntax preservation
- Extend existing handlers (VariableHandler, ExpressionHandler)

---

## Tasks

### Group 1: Literal Support (Parallel Execution)

**Task 1: String Literals** (Est. 2-3 hours)
- **Handler**: ExpressionHandler
- **Method**: `handleStringLiteral(const clang::StringLiteral* SL, HandlerContext& ctx)`
- **Implementation**:
  - Create C StringLiteral node
  - Preserve string content and encoding
  - Handle escape sequences
- **Tests** (8-10 tests):
  - Simple string literal
  - String with escape sequences (\n, \t, \", etc.)
  - Empty string
  - Multi-line string
  - String concatenation (if applicable)
  - Wide strings (optional)

**Task 2: Character Literals** (Est. 1-2 hours)
- **Handler**: ExpressionHandler
- **Method**: `handleCharacterLiteral(const clang::CharacterLiteral* CL, HandlerContext& ctx)`
- **Implementation**:
  - Create C CharacterLiteral node
  - Preserve character value and kind
  - Handle escape sequences
- **Tests** (6-8 tests):
  - Simple character literal ('a')
  - Escape sequences ('\n', '\t', '\\', '\'')
  - Numeric escapes ('\0', '\x41')
  - Wide characters (optional)

### Group 2: Array Support (Parallel Execution)

**Task 3: Array Declarations** (Est. 2-3 hours)
- **Handler**: VariableHandler
- **Method**: Extend `handleVarDecl()` to support array types
- **Implementation**:
  - Detect ArrayType in VarDecl
  - Create C VarDecl with ConstantArrayType
  - Handle array size expressions
  - Support multi-dimensional arrays
- **Tests** (10-12 tests):
  - Simple array declaration (`int arr[10]`)
  - Array with size expression (`int arr[5+5]`)
  - Multi-dimensional arrays (`int matrix[3][4]`)
  - Const arrays
  - Static arrays
  - Array of pointers (basic)

**Task 4: Array Initialization** (Est. 2-3 hours)
- **Handler**: ExpressionHandler
- **Method**: `handleInitListExpr(const clang::InitListExpr* ILE, HandlerContext& ctx)`
- **Implementation**:
  - Create C InitListExpr
  - Recursively translate initialization elements
  - Handle partial initialization
  - Handle nested initializers (for multi-dim arrays)
- **Tests** (8-10 tests):
  - Full array initialization (`{1, 2, 3}`)
  - Partial initialization (`{1, 2}` for larger array)
  - Nested initialization (multi-dim)
  - Empty initializer (`{}`)
  - Designated initializers (C99, optional)

**Task 5: Array Subscript** (Est. 1-2 hours)
- **Handler**: ExpressionHandler
- **Method**: `handleArraySubscriptExpr(const clang::ArraySubscriptExpr* ASE, HandlerContext& ctx)`
- **Implementation**:
  - Create C ArraySubscriptExpr
  - Translate base expression
  - Translate index expression
  - Support multi-dimensional indexing
- **Tests** (6-8 tests):
  - Simple subscript (`arr[0]`)
  - Variable index (`arr[i]`)
  - Expression index (`arr[i + 1]`)
  - Multi-dimensional subscript (`matrix[i][j]`)
  - Subscript as lvalue (assignment target)
  - Subscript in expression

### Group 3: Global Variables and Storage Classes (Parallel Execution)

**Task 6: Global Variables** (Est. 2-3 hours)
- **Handler**: VariableHandler
- **Method**: Extend `handleVarDecl()` to support global scope
- **Implementation**:
  - Detect global scope (DeclContext is TranslationUnitDecl)
  - Create C VarDecl at global scope
  - Handle initialization expressions
  - Register in HandlerContext symbol table
- **Tests** (10-12 tests):
  - Simple global variable
  - Global with initialization
  - Multiple globals
  - Global arrays
  - Global strings
  - Extern declarations
  - Forward declarations

**Task 7: Static Local Variables** (Est. 1-2 hours)
- **Handler**: VariableHandler
- **Method**: Extend `handleVarDecl()` to support static storage class
- **Implementation**:
  - Detect SC_Static storage class
  - Preserve static keyword in C VarDecl
  - Handle static initialization
- **Tests** (6-8 tests):
  - Static local variable
  - Static with initialization
  - Static in multiple functions
  - Static array
  - Static const

**Task 8: Const Qualifiers** (Est. 1 hour)
- **Handler**: VariableHandler
- **Method**: Extend `handleVarDecl()` to preserve const qualifiers
- **Implementation**:
  - Check QualType for const qualifier
  - Preserve const in C VarDecl type
- **Tests** (4-6 tests):
  - Const local variable
  - Const global variable
  - Const pointer vs pointer to const
  - Const array

### Group 4: Type Casts (Sequential)

**Task 9: C-Style Casts** (Est. 1-2 hours)
- **Handler**: ExpressionHandler
- **Method**: `handleCStyleCastExpr(const clang::CStyleCastExpr* CCE, HandlerContext& ctx)`
- **Implementation**:
  - Create C CStyleCastExpr
  - Translate target type
  - Translate sub-expression
  - Preserve cast kind
- **Tests** (8-10 tests):
  - Simple type cast (`(int)x`)
  - Pointer cast (`(void*)ptr`)
  - Const cast (`(char*)const_str`)
  - Cast in expression
  - Nested casts

**Task 10: Implicit Casts** (Est. 1 hour)
- **Handler**: ExpressionHandler
- **Method**: `handleImplicitCastExpr(const clang::ImplicitCastExpr* ICE, HandlerContext& ctx)`
- **Implementation**:
  - Usually transparent (return translated sub-expression)
  - Create C ImplicitCastExpr when necessary
  - Preserve cast kind for type checking
- **Tests** (6-8 tests):
  - Integer promotion
  - Float to int
  - Array to pointer decay
  - Function to pointer
  - Lvalue to rvalue conversion

### Group 5: Integration and E2E Tests (Sequential)

**Task 11: Integration Tests** (Est. 2 hours)
- **File**: `tests/integration/handlers/GlobalVariablesIntegrationTest.cpp`
- **Tests** (15-20 tests):
  - Functions using global variables
  - Functions with static locals
  - Array manipulation in functions
  - String processing functions
  - Mixed local/global/static variables
  - Arrays passed to functions
  - Multi-file simulation (extern)

**Task 12: E2E Tests** (Est. 1-2 hours)
- **File**: `tests/e2e/phase3/GlobalVariablesE2ETest.cpp`
- **Tests** (8-10 tests):
  - 1 active sanity test (global counter)
  - 7-9 disabled algorithm tests:
    - String length calculation
    - Array sum/average
    - Matrix operations
    - Static variable counter
    - Global lookup table
    - String reversal
    - Array sorting (simple)

---

## Execution Strategy

### Parallel Execution Groups

**Group 1 (Tasks 1-2): Literals** - 2 parallel subtasks
- Independent: String and character literals have no dependencies
- Duration: ~3 hours parallel (vs ~5 hours sequential)

**Group 2 (Tasks 3-5): Arrays** - 3 parallel subtasks
- Independent: Array declaration, initialization, and subscript can be developed separately
- Duration: ~3 hours parallel (vs ~7 hours sequential)

**Group 3 (Tasks 6-8): Global/Static Variables** - 3 parallel subtasks
- Independent: Global scope, static storage, const qualifiers are orthogonal concerns
- Duration: ~3 hours parallel (vs ~6 hours sequential)

**Group 4 (Tasks 9-10): Type Casts** - Sequential
- Minimal dependencies
- Duration: ~2 hours sequential

**Group 5 (Tasks 11-12): Integration/E2E** - Sequential
- Depends on all previous tasks completing
- Duration: ~3 hours sequential

**Total Estimated Time:**
- Parallel: ~14 hours (3+3+3+2+3)
- Sequential: ~24 hours
- **Time Savings: ~42%**

### Deviation Rules

1. **Clang API Issues**: If Clang API doesn't match documentation, research correct usage
2. **Test Setup Issues**: If AST creation fails, create helper methods
3. **Missing Features**: If a C++ construct has no C equivalent, document and skip
4. **Type Mismatches**: If types don't align, investigate QualType construction

---

## Success Criteria

- [ ] All 80+ unit tests pass (100%)
- [ ] All 15-20 integration tests pass (100%)
- [ ] 1 E2E sanity test passes (100%)
- [ ] Global variables work across functions
- [ ] Static locals persist across function calls
- [ ] Arrays can be declared, initialized, and accessed
- [ ] String literals work correctly
- [ ] Type casts preserve semantics
- [ ] No compiler warnings
- [ ] Code follows SOLID principles
- [ ] TDD followed throughout (tests before implementation)
- [ ] Documentation complete (this plan + SUMMARY.md)

---

## Verification

After implementation:

1. **Build and Test:**
   ```bash
   cd build
   cmake ..
   make -j$(nproc)
   ctest --output-on-failure
   ```

2. **Run specific test suites:**
   ```bash
   ./tests/unit/handlers/VariableHandlerTest
   ./tests/unit/handlers/ExpressionHandlerTest
   ./tests/integration/handlers/GlobalVariablesIntegrationTest
   ./tests/e2e/phase3/GlobalVariablesE2ETest
   ```

3. **Verify pass rates:**
   - Total Phase 3 tests: ~80
   - Combined project tests: ~312 (232 previous + 80 new)
   - Expected pass rate: 99%+

4. **Code review:**
   - Check SOLID compliance
   - Verify 1:1 C mapping
   - No over-engineering
   - Clean separation of concerns

---

## Deliverables

1. **Handler Extensions:**
   - `include/handlers/VariableHandler.h` - Global/static/const/array support
   - `src/handlers/VariableHandler.cpp` - Implementation
   - `include/handlers/ExpressionHandler.h` - String/char literals, casts, subscript
   - `src/handlers/ExpressionHandler.cpp` - Implementation

2. **Unit Tests:**
   - `tests/unit/handlers/VariableHandlerTest.cpp` - ~30 new tests
   - `tests/unit/handlers/ExpressionHandlerTest.cpp` - ~35 new tests

3. **Integration Tests:**
   - `tests/integration/handlers/GlobalVariablesIntegrationTest.cpp` - ~20 tests

4. **E2E Tests:**
   - `tests/e2e/phase3/GlobalVariablesE2ETest.cpp` - ~10 tests

5. **Documentation:**
   - `.planning/phases/41-global-variables-types/41-01-PLAN.md` - This file
   - `.planning/phases/41-global-variables-types/41-01-SUMMARY.md` - Execution summary
   - `.planning/phases/41-global-variables-types/PHASE3-COMPLETE.md` - Completion doc

6. **Build Configuration:**
   - `CMakeLists.txt` - Updated with new test executables

---

## Dependencies

**Phase 1 (Complete):**
- VariableHandler infrastructure for local variables
- ExpressionHandler infrastructure for basic expressions
- Test fixtures and infrastructure

**Phase 2 (Complete):**
- Control flow constructs for integration tests

**External Dependencies:**
- Clang/LLVM AST API
- Google Test framework
- CMake build system

---

## Implementation Notes

### 1:1 C Mapping Examples

**Global Variables:**
```cpp
// C++ Input
int globalCounter = 0;
const char* message = "Hello";

// C Output (identical)
int globalCounter = 0;
const char* message = "Hello";
```

**Static Local:**
```cpp
// C++ Input
int get_next_id() {
    static int id = 0;
    return ++id;
}

// C Output (identical)
int get_next_id(void) {
    static int id = 0;
    return ++id;
}
```

**Arrays:**
```cpp
// C++ Input
int values[10] = {1, 2, 3, 4, 5};
int sum = 0;
for (int i = 0; i < 10; i++) {
    sum += values[i];
}

// C Output (identical)
int values[10] = {1, 2, 3, 4, 5};
int sum = 0;
for (int i = 0; i < 10; i++) {
    sum += values[i];
}
```

**Type Casts:**
```cpp
// C++ Input
float x = 3.14f;
int y = (int)x;

// C Output (identical)
float x = 3.14f;
int y = (int)x;
```

### Handler Architecture

**VariableHandler Extensions:**
- Already handles local variables (Phase 1)
- Add global scope detection
- Add static storage class handling
- Add array type handling
- Add const qualifier preservation

**ExpressionHandler Extensions:**
- Already handles arithmetic, comparison, logical, unary operators (Phases 1-2)
- Add string/char literal handling
- Add array subscript handling
- Add cast expression handling
- Add initializer list handling

**No New Handlers Required:**
- All functionality fits cleanly into existing handlers
- Maintains SOLID principles (handlers remain focused)

---

## Risk Mitigation

**Risk 1: Array Type Complexity**
- Mitigation: Start with 1D arrays, then add multi-dimensional
- Fallback: Document multi-dim limitations if needed

**Risk 2: Global Variable Initialization Order**
- Mitigation: C doesn't guarantee order, neither do we
- Document: Global init order is undefined (C standard behavior)

**Risk 3: Clang AST Creation for InitListExpr**
- Mitigation: Research Clang API carefully, use helper methods
- Fallback: Create simplified version first, extend later

**Risk 4: String Literal Encoding**
- Mitigation: Support UTF-8 first (most common)
- Fallback: Document encoding limitations if needed

---

## Next Steps After Completion

**Phase 42: Structs (C-style)** - Est. 10-12 hours
- Struct declarations (no methods)
- Struct field access
- Struct initialization
- Passing structs to functions

**Phase 43: Pointers** - Est. 8-10 hours
- Pointer types
- Address-of (&) and dereference (*) operators
- Pointer arithmetic
- C++ references → C pointers

---

## TDD Workflow (Per Task)

1. **Write failing test** - Create test that exercises new functionality
2. **Run test** - Verify it fails (red)
3. **Implement minimal code** - Make test pass with simplest solution
4. **Run test** - Verify it passes (green)
5. **Refactor** - Clean up while keeping tests green
6. **Commit** - Commit working code with tests

**Example for Task 1 (String Literals):**
```cpp
// 1. Write failing test
TEST_F(ExpressionHandlerTest, SimpleStringLiteral) {
    auto testAST = buildASTFromCode(R"(
        const char* test() { return "Hello"; }
    )");
    // ... assertion that will fail initially
}

// 2. Run test → RED
// 3. Implement handleStringLiteral() → GREEN
// 4. Refactor if needed → GREEN
// 5. Commit
```

---

## Communication

**Updates:**
- Create summary after each group completes
- Report any deviations from plan
- Document any Clang API discoveries

**Final Summary:**
- Total tests added
- Pass rate
- Code volume (LOC)
- Time spent vs estimate
- Lessons learned
- Issues encountered and resolutions

---

**Plan Status**: Ready for execution
**Next Action**: Execute Group 1 (Tasks 1-2) in parallel
