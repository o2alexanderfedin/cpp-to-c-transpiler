# Phase 34-02: FileOriginTracker Implementation

**Phase**: 34 - Fix Header File Skipping (v2.5.0)
**Plan**: 34-02 - FileOriginTracker Implementation
**Type**: Implementation (TDD)
**Estimated Effort**: 1 day

---

## Objective

Implement the FileOriginTracker system to track declaration-to-file mappings, enabling selective processing of user headers while skipping system headers. This is the foundation for multi-file transpilation support.

**Why This Matters**: This component replaces the 12 `isInMainFile()` checks with intelligent file origin filtering, unblocking 70% of Phase 33 tests. Without this, multi-file C++ projects cannot be transpiled.

---

## Context

**From Phase 34-01 Research** (`.planning/phases/34-header-file-skipping/34-01-FINDINGS.md`):
- Complete FileOriginTracker interface design (lines 476-610)
- 3 core data structures: declToFile, fileCategories, fileToDecls
- Memory overhead: ~730KB for 10K declarations (negligible vs Clang AST)
- O(1) lookup performance for all queries
- 4-tier file classification: MainFile, UserHeader, SystemHeader, ThirdPartyHeader

**Design Principles** (from user requirements):
- TDD: Write tests first, then minimal implementation, then refactor
- SOLID: Single Responsibility (only tracks file origins)
- KISS: Simple hash maps, no complex algorithms
- DRY: Reuse SourceManager APIs, no custom path parsing
- Pair Programming: Explain reasoning, validate decisions

**Files to Create**:
- `include/FileOriginTracker.h` - Interface (from 34-01-FINDINGS.md lines 476-610)
- `src/FileOriginTracker.cpp` - Implementation
- `tests/FileOriginTrackerTest.cpp` - Unit tests (TDD)

---

## Tasks

### Task 1: Write Failing Unit Tests (TDD Red Phase)

**What to do**:
1. Create `tests/FileOriginTrackerTest.cpp` with comprehensive test cases
2. Write tests for:
   - Basic declaration tracking (recordDeclaration, isFromMainFile)
   - File category classification (MainFile, UserHeader, SystemHeader)
   - shouldTranspile() API (primary replacement for isInMainFile())
   - getUserHeaderFiles() for multi-file output
   - getDeclarationsFromFile() for code routing
   - User header path configuration (addUserHeaderPath)
   - System header detection (macOS paths: /usr/include, /Library, /System)
   - Statistics collection (getStatistics)
3. Use GoogleTest framework (consistent with existing tests)
4. Mock SourceManager or use real Clang test harness
5. Verify tests FAIL initially (no implementation yet)

**Verification**:
- ✅ FileOriginTrackerTest.cpp created with at least 8 test cases
- ✅ Tests compile successfully
- ✅ All tests FAIL (expected - no implementation)
- ✅ Test coverage includes all public API methods

**Test Case Examples**:
```cpp
TEST(FileOriginTrackerTest, RecordsMainFileDeclarations) {
  // Given: A declaration from main.cpp
  // When: recordDeclaration() called
  // Then: isFromMainFile() returns true
}

TEST(FileOriginTrackerTest, DetectsSystemHeaders) {
  // Given: A declaration from /usr/include/stdio.h
  // When: getFileCategory() called
  // Then: Returns FileCategory::SystemHeader
}

TEST(FileOriginTrackerTest, ShouldTranspileUserHeaders) {
  // Given: A declaration from include/MyClass.h
  // When: shouldTranspile() called
  // Then: Returns true (user headers should be transpiled)
}

TEST(FileOriginTrackerTest, ShouldNotTranspileSystemHeaders) {
  // Given: A declaration from /Library/Developer/...
  // When: shouldTranspile() called
  // Then: Returns false (system headers skipped)
}
```

---

### Task 2: Implement FileOriginTracker.h (TDD Green Phase - Part 1)

**What to do**:
1. Copy interface from 34-01-FINDINGS.md lines 476-610 to `include/FileOriginTracker.h`
2. Ensure all public methods declared
3. Add comprehensive Doxygen documentation
4. Include SOLID principle comments (Single Responsibility, Open/Closed)
5. Define FileCategory enum
6. Declare all 3 core data structures (declToFile, fileCategories, fileToDecls)
7. No implementation yet - just declarations

**Verification**:
- ✅ FileOriginTracker.h created
- ✅ All methods from design spec present
- ✅ FileCategory enum defined
- ✅ Header compiles without errors
- ✅ Include guards or #pragma once present
- ✅ Doxygen comments for all public methods

**Code Template**:
```cpp
#ifndef FILE_ORIGIN_TRACKER_H
#define FILE_ORIGIN_TRACKER_H

#include "clang/AST/Decl.h"
#include "clang/Basic/SourceManager.h"
#include <string>
#include <set>
#include <unordered_map>

namespace cpptoc {

/// @brief Tracks which declarations originate from which source files
///
/// SOLID Principles:
/// - Single Responsibility: Only tracks file origins for declarations
/// - Open/Closed: Extensible via file classification strategies
/// - Dependency Inversion: Depends on Clang SourceManager abstraction
class FileOriginTracker {
public:
  enum class FileCategory {
    MainFile,        ///< The primary input file being transpiled
    UserHeader,      ///< User-defined headers (should be transpiled)
    SystemHeader,    ///< System headers (skip: /usr/include, /Library, etc.)
    ThirdPartyHeader ///< Third-party libraries (configurable)
  };

  explicit FileOriginTracker(clang::SourceManager &SM);

  // Core API methods (from design spec)
  void recordDeclaration(const clang::Decl *D);
  bool shouldTranspile(const clang::Decl *D) const;
  // ... (rest from 34-01-FINDINGS.md)

private:
  clang::SourceManager &SM;
  std::unordered_map<const clang::Decl *, std::string> declToFile;
  std::unordered_map<std::string, FileCategory> fileCategories;
  std::unordered_map<std::string, std::set<const clang::Decl *>> fileToDecls;
  // ... (rest)
};

} // namespace cpptoc

#endif
```

---

### Task 3: Implement FileOriginTracker.cpp (TDD Green Phase - Part 2)

**What to do**:
1. Create `src/FileOriginTracker.cpp`
2. Implement constructor (initialize SourceManager reference)
3. Implement recordDeclaration():
   - Get file path from SourceManager
   - Classify file category
   - Store in all 3 data structures
4. Implement classification methods:
   - classifyFile() - 4-tier logic from design spec
   - isSystemPath() - check /usr/include, /Library, /System
   - isUserPath() - check against userHeaderPaths
5. Implement query methods:
   - shouldTranspile() = isFromMainFile() || isFromUserHeader()
   - getOriginFile() - lookup in declToFile map
   - getFileCategory() - lookup in fileCategories map
6. Implement statistics collection
7. Run tests - should pass now (TDD green)

**Verification**:
- ✅ FileOriginTracker.cpp created
- ✅ All methods implemented
- ✅ Unit tests now PASS (TDD green)
- ✅ No compiler warnings with -Wall -Wextra
- ✅ Memory leak check with valgrind (if applicable)

**Classification Algorithm** (from 34-01-FINDINGS.md):
```cpp
FileCategory FileOriginTracker::classifyFile(const std::string &filepath) const {
  // Check cache first
  auto it = fileCategories.find(filepath);
  if (it != fileCategories.end()) {
    return it->second;
  }

  // Classify
  if (SM.getMainFileID() == SM.getFileID(filepath)) {
    return FileCategory::MainFile;
  }
  if (isSystemPath(filepath)) {
    return FileCategory::SystemHeader;
  }
  if (isUserPath(filepath)) {
    return FileCategory::UserHeader;
  }
  if (isThirdPartyPath(filepath)) {
    return FileCategory::ThirdPartyHeader;
  }

  // Heuristic: in project dir → user, else system
  // ... (implement heuristic)
}
```

---

### Task 4: Refactor and Optimize (TDD Refactor Phase)

**What to do**:
1. Review implementation for code quality
2. Apply SOLID principles:
   - Single Responsibility: Each method does one thing
   - DRY: Extract common path manipulation to helpers
3. Optimize performance:
   - Ensure O(1) lookups (hash maps, not linear search)
   - Cache file classifications (already in design)
4. Add error handling:
   - Null pointer checks for Decl*
   - Invalid file path handling
5. Re-run tests - should still pass (TDD refactor)
6. Run linters (clang-tidy, cpplint)

**Verification**:
- ✅ Code follows SOLID principles
- ✅ No code duplication (DRY)
- ✅ All tests still pass after refactoring
- ✅ clang-tidy passes with no warnings
- ✅ Performance is O(1) for all queries

**Refactoring Checklist**:
- [ ] Extract getFilePath() helper for SourceManager queries
- [ ] Extract path prefix checking to reusable function
- [ ] Ensure consistent error handling across methods
- [ ] Add defensive programming (nullptr checks)
- [ ] Optimize string comparisons (avoid repeated allocations)

---

### Task 5: Integration Testing with Real Clang AST

**What to do**:
1. Create integration test using real C++ code (from Phase 34-01 test cases)
2. Use test case: `tests/multi-file-transpilation/01-simple-class/`
3. Parse Point.h, Point.cpp, main.cpp with Clang
4. Record all declarations in FileOriginTracker
5. Verify:
   - Point class from Point.h classified as UserHeader
   - Point::Point constructor from Point.cpp classified as MainFile or UserHeader
   - System includes (/usr/include) classified as SystemHeader
6. Validate shouldTranspile() returns correct values
7. Check getUserHeaderFiles() returns {"Point.h"}

**Verification**:
- ✅ Integration test created
- ✅ Real Clang AST parsing works
- ✅ FileOriginTracker correctly classifies all files
- ✅ shouldTranspile() matches expectations
- ✅ getUserHeaderFiles() returns expected set

**Integration Test Template**:
```cpp
TEST(FileOriginTrackerIntegrationTest, MultiFileSimpleClass) {
  // Given: Real C++ code (Point.h, Point.cpp, main.cpp)
  // When: Parse with Clang and record declarations
  // Then:
  //   - Point.h declarations → UserHeader
  //   - shouldTranspile() = true for user code
  //   - System headers → SystemHeader
  //   - shouldTranspile() = false for system headers
}
```

---

### Task 6: Update CMakeLists.txt and Build System

**What to do**:
1. Add FileOriginTracker.cpp to CMakeLists.txt
2. Add FileOriginTrackerTest.cpp to test targets
3. Ensure linking with Clang libraries
4. Run full build: `cd build_working && make -j$(nproc)`
5. Run tests: `./FileOriginTrackerTest`
6. Verify no build errors or warnings

**Verification**:
- ✅ CMakeLists.txt updated
- ✅ Full build succeeds
- ✅ All FileOriginTracker tests pass
- ✅ No regression in existing tests

**CMakeLists.txt Changes**:
```cmake
# Add to source files list
set(SOURCES
  src/FileOriginTracker.cpp
  # ... existing sources
)

# Add to test executables
add_executable(FileOriginTrackerTest tests/FileOriginTrackerTest.cpp)
target_link_libraries(FileOriginTrackerTest ${CLANG_LIBS} gtest gtest_main)
```

---

## Success Criteria

This phase is successful when:
- ✅ FileOriginTracker.h fully implements design from 34-01-FINDINGS.md
- ✅ FileOriginTracker.cpp passes all unit tests (TDD green)
- ✅ Integration test validates real Clang AST usage
- ✅ shouldTranspile() correctly replaces isInMainFile() checks
- ✅ Memory overhead <1MB verified via statistics
- ✅ O(1) lookup performance confirmed
- ✅ System header detection works on macOS (/usr/include, /Library, /System)
- ✅ Full build succeeds with no warnings
- ✅ All tests pass (100% success rate)
- ✅ Code follows TDD, SOLID, KISS, DRY principles

---

## Output

**Primary Deliverables**:
- `include/FileOriginTracker.h` (interface)
- `src/FileOriginTracker.cpp` (implementation)
- `tests/FileOriginTrackerTest.cpp` (unit tests)

**SUMMARY.md Required**:
Create `.planning/phases/34-header-file-skipping/34-02-SUMMARY.md` with:

```markdown
# Phase 34-02 Summary: FileOriginTracker Implementation

**One-liner**: [Substantive summary of what was built]

**Version**: v1

## Key Findings
- [Test coverage percentage]
- [Performance metrics (memory, speed)]
- [Integration test results]

## Decisions Needed
- [Any architectural questions discovered]

## Blockers
- [Any impediments encountered]

## Next Step
- Execute Phase 34-03: [specific next action]
```

---

## Deviation Rules (Auto-Applied During Execution)

1. **Auto-fix bugs**: If implementation has bugs, fix immediately with tests
2. **Auto-add missing critical**: If missing edge cases discovered, add tests + fix
3. **Auto-fix blockers**: If Clang API issues found, resolve and document
4. **Ask about architectural**: Major design changes → stop and ask user
5. **Log enhancements**: Nice-to-have features → log to ISSUES.md

All deviations will be documented in SUMMARY.md.

---

## Quality Controls

### Verification Checklist
Before declaring this phase complete:
- [ ] All 6 tasks completed with verification criteria met
- [ ] TDD cycle followed: Red → Green → Refactor
- [ ] Unit tests cover all public API methods
- [ ] Integration test validates real Clang AST usage
- [ ] Code passes linters (clang-tidy)
- [ ] Memory leak check passes
- [ ] Full build succeeds with no warnings
- [ ] SUMMARY.md created with substantive content

### Test Coverage Requirements
- Constructor and destructor
- recordDeclaration() with various declaration types
- File classification (all 4 categories)
- shouldTranspile() true/false cases
- Query methods (getOriginFile, getFileCategory)
- Configuration methods (addUserHeaderPath, setTranspileThirdParty)
- Statistics collection
- Edge cases (null pointers, invalid paths, symlinks)

---

**Ready to execute**: Use subagent for autonomous execution or manual step-through

**TDD Principles**: Red (failing tests) → Green (minimal implementation) → Refactor (optimize + clean)

**SOLID Compliance**: Single Responsibility (file tracking only), Open/Closed (extensible classification), Dependency Inversion (depends on Clang abstractions)
