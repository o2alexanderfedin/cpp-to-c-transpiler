# Phase 34-06: Translation-Aware Code Printer

**Phase**: 34 - Fix Header File Skipping (v2.5.0)
**Plan**: 34-06 - Custom Code Printer for Translated AST
**Type**: Implementation (TDD)
**Estimated Effort**: 2-3 days

---

## Objective

Implement a custom translation-aware code printer that uses translated C AST nodes instead of original C++ AST nodes, enabling generated C code to compile and execute correctly.

**Why This Matters**: Phase 34-05 implemented perfect translation logic but discovered that Clang's default printer outputs original C++ nodes instead of translated C nodes. This phase fixes the printer to use translation maps, unblocking all code generation and enabling Phase 33 validation.

---

## Context

**From Phase 34-05 Discovery**:
- Translation logic works perfectly ‚úÖ (verified via debug output)
- Creates correct C AST nodes ‚úÖ
- But Clang's printer uses original C++ nodes ‚ùå
- Result: C++ syntax in output despite correct translation

**Root Cause**:
```cpp
// Current flow:
1. Clang parses Point.h ‚Üí C++ AST nodes created
2. CppToCVisitor translates ‚Üí C AST nodes created
3. CodeGenerator prints ‚Üí Uses ORIGINAL C++ nodes! ‚ùå

// Needed flow:
1. Clang parses Point.h ‚Üí C++ AST nodes created
2. CppToCVisitor translates ‚Üí C AST nodes created
3. CustomPrinter checks translation maps FIRST
4. If translated node found ‚Üí print C AST ‚úÖ
5. Else ‚Üí print original (fallback)
```

**Translation Maps Available** (from Phase 34-05):
- `cppToCMap` - C++ AST ‚Üí C AST mapping
- `methodToCFunc` - C++ methods ‚Üí C functions
- `ctorMap` - C++ constructors ‚Üí C init functions

**Design Principles**:
- TDD: Write tests for printer behavior
- SOLID: Extend CodeGenerator without breaking it
- KISS: Simple map lookup before printing
- DRY: Reuse existing CodeGenerator logic
- Emergent Design: Let printer patterns emerge from tests

**Files to Create/Modify**:
- `include/TranslationAwareCodeGenerator.h` - New custom printer
- `src/TranslationAwareCodeGenerator.cpp` - Implementation
- `src/CodeGenerator.cpp` - Use custom printer when translations exist
- `tests/TranslationAwareCodeGeneratorTest.cpp` - TDD tests

---

## Tasks

### Task 1: Design Translation-Aware Printer API (TDD - Red Phase)

**What to do**:
1. Create header: `include/TranslationAwareCodeGenerator.h`
2. Design class extending CodeGenerator:
   ```cpp
   #ifndef TRANSLATION_AWARE_CODE_GENERATOR_H
   #define TRANSLATION_AWARE_CODE_GENERATOR_H

   #include "CodeGenerator.h"
   #include "clang/AST/Stmt.h"
   #include "clang/AST/Decl.h"
   #include <unordered_map>

   namespace cpptoc {

   /// Custom code printer that checks translation maps before printing
   /// Uses translated C AST nodes when available, falls back to original
   class TranslationAwareCodeGenerator : public CodeGenerator {
   public:
     TranslationAwareCodeGenerator(
       const std::unordered_map<const clang::Stmt*, clang::Stmt*> &cppToCMap,
       const std::unordered_map<const clang::CXXMethodDecl*, std::string> &methodToCFunc,
       const std::unordered_map<const clang::CXXConstructorDecl*, std::string> &ctorMap
     );

     /// Override to check translation maps before printing
     void printStmt(const clang::Stmt *S) override;

     /// Override to check method translation
     void printDecl(const clang::Decl *D) override;

   private:
     const std::unordered_map<const clang::Stmt*, clang::Stmt*> &cppToCMap;
     const std::unordered_map<const clang::CXXMethodDecl*, std::string> &methodToCFunc;
     const std::unordered_map<const clang::CXXConstructorDecl*, std::string> &ctorMap;

     /// Check if statement has translation
     bool hasTranslation(const clang::Stmt *S) const;

     /// Print translated statement
     void printTranslatedStmt(const clang::Stmt *Original);
   };

   } // namespace cpptoc

   #endif
   ```
3. Write failing test in `tests/TranslationAwareCodeGeneratorTest.cpp`:
   ```cpp
   TEST(TranslationAwareCodeGeneratorTest, UsesTranslatedStmtWhenAvailable) {
     // Given: C++ stmt with translation in map
     // When: printStmt() called
     // Then: Prints translated C stmt (not original C++)
   }
   ```
4. Verify test compiles but fails

**Verification**:
- ‚úÖ Header created with API design
- ‚úÖ Test written and compiles
- ‚úÖ Test fails (expected - no implementation)

---

### Task 2: Implement Translation-Aware Printer (TDD - Green Phase)

**What to do**:
1. Create `src/TranslationAwareCodeGenerator.cpp`
2. Implement constructor:
   ```cpp
   TranslationAwareCodeGenerator::TranslationAwareCodeGenerator(
       const std::unordered_map<const Stmt*, Stmt*> &cppToCMap,
       const std::unordered_map<const CXXMethodDecl*, std::string> &methodToCFunc,
       const std::unordered_map<const CXXConstructorDecl*, std::string> &ctorMap)
     : cppToCMap(cppToCMap), methodToCFunc(methodToCFunc), ctorMap(ctorMap) {}
   ```
3. Implement `printStmt()`:
   ```cpp
   void TranslationAwareCodeGenerator::printStmt(const Stmt *S) {
     if (!S) {
       CodeGenerator::printStmt(S);
       return;
     }

     // Check if this statement has a translation
     auto it = cppToCMap.find(S);
     if (it != cppToCMap.end() && it->second) {
       // Use translated C AST node
       CodeGenerator::printStmt(it->second);
     } else {
       // No translation - use original (may be pure C already)
       CodeGenerator::printStmt(S);
     }
   }
   ```
4. Implement `printDecl()` for method translations
5. Run test - should pass now

**Verification**:
- ‚úÖ Implementation complete
- ‚úÖ Test passes (TDD green)
- ‚úÖ Printer uses translation maps

---

### Task 3: Integrate with CodeGenerator (TDD)

**What to do**:
1. Modify `src/CodeGenerator.cpp` to use custom printer
2. Check if translation maps are populated:
   ```cpp
   void CodeGenerator::generateCode() {
     // Check if translations exist
     if (!cppToCMap.empty()) {
       // Use translation-aware printer
       TranslationAwareCodeGenerator printer(cppToCMap, methodToCFunc, ctorMap);
       printer.printStmt(rootStmt);
     } else {
       // No translations - use default printer
       defaultPrint(rootStmt);
     }
   }
   ```
3. Update CodeGenerator to have access to translation maps
4. Write integration test

**Verification**:
- ‚úÖ CodeGenerator uses custom printer when translations exist
- ‚úÖ Falls back to default when no translations
- ‚úÖ Integration test passes

---

### Task 4: Test with Real Point.cpp Example (Integration)

**What to do**:
1. Run transpilation with Point.cpp/main.cpp:
   ```bash
   ./build_working/cpptoc tests/multi-file-transpilation/01-simple-class/Point.cpp \
     tests/multi-file-transpilation/01-simple-class/main.cpp \
     --output-dir output/
   ```
2. Examine generated C code:
   ```bash
   cat output/main.c
   ```
3. Verify C syntax (not C++):
   ```c
   // Should see:
   struct Point p;
   Point__ctor(&p, 3.0, 4.0);  // ‚úÖ C syntax

   // NOT:
   Point p(3, 4);  // ‚ùå C++ syntax
   ```
4. Compile generated C:
   ```bash
   cd output
   gcc -c Point.c -o Point.o
   gcc -c main.c -o main.o
   gcc Point.o main.o -o test_point
   ```
5. Run binary:
   ```bash
   ./test_point
   echo $?  # Should be 0 (success)
   ```

**Verification**:
- ‚úÖ Generated C code has proper C syntax
- ‚úÖ C code compiles without errors
- ‚úÖ Binary runs successfully
- ‚úÖ Behavior matches C++ original

---

### Task 5: Run Phase 33 Validation Suite (Final Validation)

**What to do**:
1. Navigate to Phase 33 suite:
   ```bash
   cd tests/real-world/cpp23-validation/ab-test
   ```
2. Run validation:
   ```bash
   ./run-tests.sh
   ./compare.py
   ```
3. Measure pass rate:
   - Before Phase 34: 0/130 (0%)
   - After Phase 34-06: X/130 (Y%)
4. Analyze by category:
   - Which categories improved?
   - Which still fail and why?
5. Document in SUMMARY.md

**Expected Results** (from Phase 34-01 estimates):
- Conservative: 15-30/130 (12-23%)
- Optimistic: 80-100/130 (60-80%) if printer fixes all issues

**Verification**:
- ‚úÖ Validation suite runs successfully
- ‚úÖ Pass rate improved significantly from 0%
- ‚úÖ Results analyzed by category
- ‚úÖ Improvements documented

---

### Task 6: Handle Edge Cases and Refinements

**What to do**:
1. Test edge cases discovered during validation:
   - Nested statements with partial translations
   - Mixed C++ and C code in same function
   - Template instantiations
2. Add defensive programming:
   - Null pointer checks
   - Invalid translation handling
   - Fallback to original on errors
3. Optimize performance:
   - Cache translation lookups if needed
   - Avoid redundant map searches
4. Document known limitations

**Verification**:
- ‚úÖ Edge cases handled
- ‚úÖ Defensive checks in place
- ‚úÖ Performance acceptable
- ‚úÖ Limitations documented

---

### Task 7: Update Documentation and Commit

**What to do**:
1. Update `docs/CODE_GENERATION.md`:
   - Document translation-aware printer
   - Explain how it works
   - Provide usage examples
2. Update `README.md`:
   - Multi-file transpilation now works
   - Generated C compiles and runs
3. Create comprehensive commit
4. Include Phase 33 results

**Commit Message Format**:
```
feat(phase-34-06): Implement translation-aware code printer

Implemented custom code printer that uses translated C AST nodes instead
of original C++ nodes, fixing code generation quality issues.

Solution:
- TranslationAwareCodeGenerator extends CodeGenerator
- Checks translation maps (cppToCMap, methodToCFunc, ctorMap) before printing
- Uses translated C AST when available, falls back to original
- Integrated with CodeGenerator

Results:
- Generated C code now has proper C syntax ‚úÖ
- Real-world test (Point.cpp) compiles and runs ‚úÖ
- Phase 33 validation: 0% ‚Üí X% pass rate (X/130 tests)

Impact:
- Multi-file transpilation produces working C code
- Phase 34 objectives achieved

ü§ñ Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

**Verification**:
- ‚úÖ Documentation updated
- ‚úÖ Commit created with results
- ‚úÖ Phase 33 metrics included

---

## Success Criteria

This phase is successful when:
- ‚úÖ TranslationAwareCodeGenerator implemented and tested
- ‚úÖ Printer checks translation maps before printing
- ‚úÖ Real Point.cpp example generates valid C code
- ‚úÖ Generated C compiles with gcc/clang (no errors)
- ‚úÖ Binary executes correctly
- ‚úÖ Phase 33 pass rate improves from 0% to 12-80%
- ‚úÖ All existing tests pass (no regressions)
- ‚úÖ Documentation updated
- ‚úÖ Code committed

---

## Output

**Primary Deliverables**:
- `include/TranslationAwareCodeGenerator.h` - Custom printer header
- `src/TranslationAwareCodeGenerator.cpp` - Implementation
- Modified `src/CodeGenerator.cpp` - Integration
- `tests/TranslationAwareCodeGeneratorTest.cpp` - TDD tests
- Phase 33 validation results
- Updated documentation

**SUMMARY.md Required**:
Create `.planning/phases/34-header-file-skipping/34-06-SUMMARY.md` with:

```markdown
# Phase 34-06 Summary: Translation-Aware Code Printer

**One-liner**: [Substantive summary]

**Version**: v1

## Key Achievements
- [Custom printer implementation]
- [Phase 33 results: 0% ‚Üí X%]
- [Real-world test success]

## Decisions Made
- [Printer architecture]
- [Integration approach]

## Blockers Encountered
- [Any issues]

## Next Step
- Phase 34 complete or next enhancement
```

---

## Deviation Rules (Auto-Applied During Execution)

1. **Auto-fix bugs**: Printer errors ‚Üí fix immediately
2. **Auto-add missing critical**: Missing translation checks ‚Üí add them
3. **Auto-fix blockers**: Compilation errors ‚Üí resolve
4. **Ask about architectural**: Major printer redesign ‚Üí ask user
5. **Log enhancements**: Nice-to-have features ‚Üí log to ISSUES.md

All deviations will be documented in SUMMARY.md.

---

## Quality Controls

### Verification Checklist
Before declaring this phase complete:
- [ ] All 7 tasks completed
- [ ] Custom printer implemented
- [ ] Real Point.cpp compiles
- [ ] Binary runs correctly
- [ ] Phase 33 pass rate improved
- [ ] Documentation updated
- [ ] SUMMARY.md created
- [ ] Code committed

### Test Coverage
- Translation-aware printer unit tests
- Integration with CodeGenerator
- Real Point.cpp example
- Phase 33 validation suite (130 tests)

### Compilation Validation
- gcc compilation succeeds
- clang compilation succeeds
- No warnings with -Wall -Wextra
- Binary executes correctly

---

**Ready to execute**: Use subagent for autonomous execution

**TDD Principles**: Test printer behavior before implementation

**SOLID**: Extend CodeGenerator via inheritance (Open/Closed principle)

**Critical Success**: Generated C code must compile and run - this is the final validation!
