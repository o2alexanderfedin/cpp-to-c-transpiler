# Phase 34-03: Integrate FileOriginTracker into Transpiler

**Phase**: 34 - Fix Header File Skipping (v2.5.0)
**Plan**: 34-03 - FileOriginTracker Integration
**Type**: Implementation (TDD + Integration)
**Estimated Effort**: 1-2 days

---

## Objective

Integrate FileOriginTracker into the transpiler by replacing all 12 `isInMainFile()` checks with `shouldTranspile()` API calls, enabling multi-file transpilation and unblocking 70% of Phase 33 failing tests.

**Why This Matters**: This integration transforms the transpiler from single-file-only to multi-file capable. Without this, the FileOriginTracker implementation (Phase 34-02) has no effect, and 70% of tests remain blocked.

---

## Context

**From Phase 34-01 Research** (`.planning/phases/34-header-file-skipping/34-01-FINDINGS.md`):
- 12 `isInMainFile()` locations identified (lines 293-445)
- Priority classification: High (4 sites), Medium (2 sites), Low (6 sites)
- Affects: VirtualMethodAnalyzer, VptrInjector, VtableGenerator, CppToCConsumer, and 8 others

**From Phase 34-02 Implementation** (`.planning/phases/34-header-file-skipping/34-02-SUMMARY.md`):
- FileOriginTracker is production-ready (100% test pass rate)
- API: `shouldTranspile(const Decl *D)` replaces `isInMainFile(D->getLocation())`
- Integration pattern tested and validated
- Memory overhead: ~58 bytes/decl (negligible)

**Design Principles** (from user requirements):
- TDD: Write tests for each integration point
- SOLID: Dependency Injection of FileOriginTracker
- KISS: Simple one-to-one replacement of checks
- DRY: Reuse tracker instance across all components
- Pair Programming: Explain reasoning, validate decisions

**Files to Modify**:
- `src/CppToCVisitor.cpp` - Main visitor with most isInMainFile() checks
- `src/VirtualMethodAnalyzer.cpp` - High priority (line 64)
- `src/VptrInjector.cpp` - High priority (line 58)
- `src/VtableGenerator.cpp` - High priority (line 56)
- Plus 8 other files (medium/low priority)

---

## Tasks

### Task 1: Add FileOriginTracker to CppToCConsumer (TDD)

**What to do**:
1. Read `src/CppToCConsumer.cpp` and `include/CppToCConsumer.h`
2. Add FileOriginTracker member variable:
   ```cpp
   class CppToCConsumer {
   private:
     FileOriginTracker fileOriginTracker;
   };
   ```
3. Initialize in constructor:
   ```cpp
   CppToCConsumer::CppToCConsumer(SourceManager &SM, ...)
     : fileOriginTracker(SM), ... {}
   ```
4. Configure user header paths (auto-detect from project structure):
   ```cpp
   // Add current directory and common header directories
   fileOriginTracker.addUserHeaderPath(".");
   fileOriginTracker.addUserHeaderPath("include/");
   fileOriginTracker.addUserHeaderPath("src/");
   ```
5. Pass tracker to CppToCVisitor via constructor
6. Update all call sites of CppToCVisitor constructor
7. Write integration test for CppToCConsumer

**Verification**:
- âœ… FileOriginTracker member added to CppToCConsumer
- âœ… Initialization in constructor works
- âœ… User header paths configured
- âœ… CppToCVisitor receives tracker reference
- âœ… Integration test passes
- âœ… Build succeeds with no errors

---

### Task 2: Replace isInMainFile() in High-Priority Sites (TDD)

**What to do** (for each of 4 high-priority sites):

**Site 1: VirtualMethodAnalyzer (Line 64)**
1. Read test file: `tests/VirtualMethodAnalyzerTest.cpp`
2. Add test case for header file processing:
   ```cpp
   TEST(VirtualMethodAnalyzerTest, AnalyzesClassesFromUserHeaders) {
     // Given: A class defined in user header (not main file)
     // When: analyzeClass() called with tracker.shouldTranspile() = true
     // Then: Class is analyzed (not skipped)
   }
   ```
3. Read `src/VirtualMethodAnalyzer.cpp` line 64
4. Replace:
   ```cpp
   // OLD:
   if (!SM.isInMainFile(RD->getLocation())) return;

   // NEW:
   if (!fileOriginTracker.shouldTranspile(RD)) return;
   ```
5. Add FileOriginTracker parameter to constructor/methods as needed
6. Run test - should pass
7. Repeat for remaining 3 high-priority sites

**Site 2: VptrInjector (Line 58)**
**Site 3: VtableGenerator (Line 56)**
**Site 4: CppToCConsumer::HandleTagDeclDefinition (Line 193)**

**Verification**:
- âœ… Tests written for all 4 high-priority sites
- âœ… All 4 replacements completed
- âœ… All tests pass (no regressions)
- âœ… Build succeeds
- âœ… Existing unit tests still pass

---

### Task 3: Replace isInMainFile() in Medium-Priority Sites (TDD)

**What to do** (for each of 2 medium-priority sites):

**Site 5: DependencyAnalyzer (Line 84)**
**Site 6: DependencyGraphVisualizer (Line 78)**

Same TDD process as Task 2:
1. Write test for header file handling
2. Replace `isInMainFile()` with `shouldTranspile()`
3. Add FileOriginTracker parameter
4. Verify test passes

**Verification**:
- âœ… Tests written for both medium-priority sites
- âœ… Both replacements completed
- âœ… All tests pass
- âœ… Build succeeds

---

### Task 4: Replace isInMainFile() in Low-Priority Sites

**What to do** (for each of 6 low-priority sites):

**Site 7: HeaderSeparator (Line 127)**
**Site 8: CodeGenerator (Line 212)**
**Site 9: TemplateExtractor (Line 149)**
**Site 10: TypeInfoGenerator (Line 98)**
**Site 11: DynamicCastTranslator (Line 167)**
**Site 12: OverrideResolver (Line 223)**

**Simplified approach** (these are documentation/optimization, lower risk):
1. Read each file
2. Replace `isInMainFile()` with `shouldTranspile()`
3. Add FileOriginTracker parameter
4. Quick smoke test (build + existing tests)

**Verification**:
- âœ… All 6 replacements completed
- âœ… Build succeeds
- âœ… Existing tests still pass

---

### Task 5: Multi-File Integration Test with Phase 34 Test Cases

**What to do**:
1. Use test cases from Phase 34-01: `tests/multi-file-transpilation/01-simple-class/`
2. Create integration test: `tests/MultiFileIntegrationTest.cpp`
3. Test scenario:
   ```cpp
   TEST(MultiFileIntegrationTest, TranspilesPointClassFromHeaders) {
     // Given: Point.h (user header) + Point.cpp + main.cpp
     // When: Transpile all files with FileOriginTracker enabled
     // Then:
     //   - Point class from Point.h is transpiled (not skipped)
     //   - Point constructor from Point.cpp is transpiled
     //   - main.cpp is transpiled
     //   - System headers are skipped
   }
   ```
4. Run full transpilation pipeline with multi-file input
5. Verify all user code transpiled, system headers skipped
6. Compare with expected output

**Verification**:
- âœ… Integration test created
- âœ… Test passes with multi-file input
- âœ… User headers transpiled correctly
- âœ… System headers skipped
- âœ… Generated C code compiles

---

### Task 6: Run Phase 33 Validation Suite (Verification)

**What to do**:
1. Navigate to Phase 33 test suite: `tests/real-world/cpp23-validation/`
2. Run A/B test framework:
   ```bash
   cd tests/real-world/cpp23-validation/ab-test
   ./run-tests.sh
   ```
3. Analyze results with compare.py:
   ```bash
   ./compare.py
   ```
4. Calculate new pass rate
5. Identify which test categories improved
6. Document any remaining failures

**Expected Results** (from Phase 34-01 estimates):
- **Before**: 0/130 tests passing (0%)
- **After**: 15-30/130 tests passing (12-23%)
- **Categories improving**:
  - multidim-subscript: 12-14/16 (75-85%)
  - static-operators: 6-7/8 (75-85%)
  - [[assume]]: 10-11/13 (75-85%)
  - if consteval: 8-10/13 (60-75%)
  - auto(x): 8-12/22 (35-55%)

**Verification**:
- âœ… Phase 33 tests run successfully
- âœ… Pass rate improved from 0% to 12-23%
- âœ… Multi-file tests now pass
- âœ… Results documented in SUMMARY.md

---

### Task 7: Update Documentation and Commit

**What to do**:
1. Update `docs/MULTI_FILE_TRANSPILATION.md` (if exists) or create it
2. Document FileOriginTracker usage for users:
   - How to configure user header paths
   - How third-party headers are handled
   - Command-line flags (if any)
3. Update `README.md` with multi-file support mention
4. Create comprehensive commit message
5. Commit all changes

**Commit Message Format**:
```
feat(phase-34-03): Integrate FileOriginTracker into transpiler

Replaced 12 isInMainFile() checks with shouldTranspile() API across
all transpiler components, enabling multi-file C++ transpilation.

Integration points:
- CppToCConsumer: FileOriginTracker initialization
- VirtualMethodAnalyzer, VptrInjector, VtableGenerator (high priority)
- DependencyAnalyzer, DependencyGraphVisualizer (medium priority)
- 6 additional sites (low priority)

Results:
- Phase 33 pass rate: 0% â†’ 12-23% (estimated)
- Multi-file projects now transpilable
- User headers processed correctly
- System headers skipped as expected

Test coverage:
- Integration test with multi-file Point class
- All existing tests pass (no regressions)
- Phase 33 validation suite re-run

ðŸ¤– Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

**Verification**:
- âœ… Documentation updated
- âœ… Commit created with descriptive message
- âœ… All changes committed

---

## Success Criteria

This phase is successful when:
- âœ… All 12 `isInMainFile()` checks replaced with `shouldTranspile()`
- âœ… FileOriginTracker integrated into CppToCConsumer
- âœ… User header paths auto-configured
- âœ… All existing tests pass (no regressions)
- âœ… Multi-file integration test passes
- âœ… Phase 33 pass rate improves from 0% to 12-23%
- âœ… Build succeeds with no warnings
- âœ… Documentation updated
- âœ… Code committed with comprehensive message

---

## Output

**Primary Deliverables**:
- Modified transpiler source files (12 replacements)
- Integration test: `tests/MultiFileIntegrationTest.cpp`
- Updated documentation
- Phase 33 validation results

**SUMMARY.md Required**:
Create `.planning/phases/34-header-file-skipping/34-03-SUMMARY.md` with:

```markdown
# Phase 34-03 Summary: FileOriginTracker Integration

**One-liner**: [Substantive summary of integration results]

**Version**: v1

## Key Achievements
- [Number of sites integrated]
- [Test pass rate improvement]
- [Integration test results]

## Decisions Made
- [Auto-configuration approach]
- [Priority order for replacements]

## Blockers Encountered
- [Any issues discovered]

## Next Step
- Execute Phase 34-04: [specific next action]
```

---

## Deviation Rules (Auto-Applied During Execution)

1. **Auto-fix bugs**: If integration reveals bugs in FileOriginTracker, fix immediately
2. **Auto-add missing critical**: If missing edge cases discovered, add tests + fix
3. **Auto-fix blockers**: If SourceManager issues found, resolve and document
4. **Ask about architectural**: Major design changes to components â†’ stop and ask user
5. **Log enhancements**: Nice-to-have features â†’ log to ISSUES.md

All deviations will be documented in SUMMARY.md.

---

## Quality Controls

### Verification Checklist
Before declaring this phase complete:
- [ ] All 7 tasks completed with verification criteria met
- [ ] All 12 isInMainFile() replacements done
- [ ] FileOriginTracker integrated into main components
- [ ] Integration test validates multi-file transpilation
- [ ] Phase 33 pass rate improved (0% â†’ 12-23%)
- [ ] All existing tests pass (no regressions)
- [ ] Build succeeds with no warnings
- [ ] Documentation updated
- [ ] SUMMARY.md created with substantive content
- [ ] Code committed

### Test Coverage Requirements
- High-priority site integration tests (4 tests)
- Medium-priority site integration tests (2 tests)
- Multi-file integration test (Point class)
- Phase 33 validation suite (130 tests)
- All existing unit tests (must pass)

### Performance Validation
- Memory overhead remains <1MB
- Transpilation time increase <10%
- Build time increase <5%

---

**Ready to execute**: Use subagent for autonomous execution

**TDD Principles**: Test each integration point before replacement

**SOLID Compliance**: Dependency Injection of FileOriginTracker into components

**Integration Strategy**: High priority â†’ Medium priority â†’ Low priority â†’ Validation
