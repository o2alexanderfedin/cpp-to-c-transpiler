# Phase 34-01: Multi-File Transpilation Architecture Research

**Phase**: 34 - Fix Header File Skipping (v2.5.0)
**Plan**: 34-01 - Architecture Research
**Type**: Research
**Estimated Effort**: 2-3 days

---

## Objective

Research and design the architecture for multi-file transpilation by analyzing current FileOutputManager behavior, documenting all `isInMainFile()` usage sites, and designing a FileOriginTracker system to enable header file transformation.

**Why This Matters**: This is the **#1 blocker** preventing real-world C++23 code transpilation. 70% of Phase 33 tests fail because header declarations are silently skipped. Multi-file projects are completely broken.

---

## Context

**From Gaps Analysis** (`.prompts/045-cpp23-gaps-analysis/`):
- CppToCVisitor systematically skips ALL header declarations using `isInMainFile()` at 12 locations
- Affects visitors: VisitCXXRecordDecl, VisitCXXMethodDecl, VisitCXXConstructorDecl, and 9 others
- Phase 33 baseline: 0/130 tests passing, ~91 tests blocked by header skipping (70%)
- Silent failure mode - no error messages, just zero output

**Current Files Involved**:
- `include/FileOutputManager.h` - Manages output generation
- `src/FileOutputManager.cpp` - Implementation
- `src/CppToCVisitor.cpp` - Contains 12 `isInMainFile()` checks
- `include/IncludeGuardGenerator.h` - Header guard generation
- `src/IncludeGuardGenerator.cpp` - Implementation

**Expected Output**:
- Research findings document: `.planning/phases/34-header-file-skipping/34-01-FINDINGS.md`
- FileOriginTracker design specification
- Test plan for multi-file transpilation

---

## Tasks

### Task 1: Analyze Current FileOutputManager Behavior (1 day)

**What to do**:
1. Read `include/FileOutputManager.h` and `src/FileOutputManager.cpp` completely
2. Understand how output is currently generated (single .h/.c file pair)
3. Analyze `writeHeader()` and `writeImplementation()` methods
4. Document current assumptions about file structure
5. Identify what needs to change for multi-file support

**Verification**:
- ✅ FileOutputManager behavior fully documented
- ✅ Current limitations identified
- ✅ Change requirements listed

**Output to FINDINGS.md**:
```xml
<current-behavior>
  <header-generation>...</header-generation>
  <implementation-generation>...</implementation-generation>
  <limitations>...</limitations>
</current-behavior>
```

---

### Task 2: Document All isInMainFile() Usage Sites (4-6 hours)

**What to do**:
1. Search `src/CppToCVisitor.cpp` for all `isInMainFile()` calls
2. For each location, document:
   - Line number
   - Visitor method (e.g., VisitCXXRecordDecl)
   - What gets skipped
   - Why it was added (check git history if needed)
   - Impact of removing it
3. Create comprehensive table of all 12 locations
4. Identify any dependencies between checks

**Verification**:
- ✅ All 12 isInMainFile() locations documented
- ✅ Impact analysis complete
- ✅ Dependencies identified

**Output to FINDINGS.md**:
```xml
<ismainfile-locations>
  <location line="136" visitor="VisitCXXRecordDecl">
    <impact>Skips all classes defined in headers</impact>
    <reason>...</reason>
  </location>
  <!-- Repeat for all 12 locations -->
</ismainfile-locations>
```

---

### Task 3: Design FileOriginTracker System (1 day)

**What to do**:
1. Design a class to track which declarations come from which files
2. Specify interface:
   ```cpp
   class FileOriginTracker {
   public:
     void recordDeclaration(const Decl *D, const std::string &filename);
     bool isFromMainFile(const Decl *D) const;
     bool isFromHeader(const Decl *D) const;
     std::string getOriginFile(const Decl *D) const;
     std::set<std::string> getAllHeaderFiles() const;
   };
   ```
3. Design data structures (maps, sets needed)
4. Plan integration points with CppToCVisitor
5. Create usage examples

**Verification**:
- ✅ FileOriginTracker interface specified
- ✅ Data structures designed
- ✅ Integration plan documented

**Output to FINDINGS.md**:
```xml
<file-origin-tracker-design>
  <interface>...</interface>
  <data-structures>...</data-structures>
  <integration-points>...</integration-points>
  <usage-examples>...</usage-examples>
</file-origin-tracker-design>
```

---

### Task 4: Create Multi-File Test Cases (4-6 hours)

**What to do**:
1. Create test directory: `tests/multi-file-transpilation/`
2. Create simple test case:
   ```
   tests/multi-file-transpilation/01-simple-class/
     ├── main.cpp
     ├── MyClass.h
     └── MyClass.cpp
   ```
3. MyClass.h: Simple class with methods
4. MyClass.cpp: Method implementations
5. main.cpp: Uses MyClass
6. Document expected transpiled output structure
7. Create 2-3 more test cases of increasing complexity

**Verification**:
- ✅ At least 3 multi-file test cases created
- ✅ Expected output documented
- ✅ Test cases cover: simple class, inheritance, templates

**Output**:
- Test directory created with source files
- Expected output documented in FINDINGS.md

---

## Success Criteria

This research is successful when:
- ✅ FileOutputManager behavior fully understood and documented
- ✅ All 12 isInMainFile() locations documented with impact analysis
- ✅ FileOriginTracker system designed with complete specification
- ✅ Multi-file test cases created and expected output documented
- ✅ Clear path forward for Phases 34-02 through 34-06 identified
- ✅ No ambiguities remain - implementation can proceed directly

---

## Output

**Primary Deliverable**: `.planning/phases/34-header-file-skipping/34-01-FINDINGS.md`

**Required Structure**:
```xml
<findings>
  <metadata>
    <phase>34-01</phase>
    <completed>YYYY-MM-DD</completed>
    <researcher>Claude Sonnet 4.5</researcher>
  </metadata>

  <current-behavior>
    <!-- Task 1 output -->
  </current-behavior>

  <ismainfile-locations>
    <!-- Task 2 output -->
  </ismainfile-locations>

  <file-origin-tracker-design>
    <!-- Task 3 output -->
  </file-origin-tracker-design>

  <test-cases>
    <!-- Task 4 output -->
  </test-cases>

  <recommendations>
    <for-phase-34-02>...</for-phase-34-02>
    <for-phase-34-03>...</for-phase-34-03>
    <for-phase-34-04>...</for-phase-34-04>
    <for-phase-34-05>...</for-phase-34-05>
    <for-phase-34-06>...</for-phase-34-06>
  </recommendations>

  <open-questions>
    <!-- Any unresolved questions -->
  </open-questions>

  <confidence>HIGH|MEDIUM|LOW</confidence>
</findings>
```

**SUMMARY.md Required**:
Create `.planning/phases/34-header-file-skipping/34-01-SUMMARY.md` with:

```markdown
# Phase 34-01 Summary: Multi-File Transpilation Architecture Research

**One-liner**: [Substantive summary of what was discovered]

**Version**: v1

## Key Findings
- [3-5 bullet points of critical discoveries]

## Decisions Needed
- [Any architectural choices requiring user input]

## Blockers
- [Any impediments discovered]

## Next Step
- Execute Phase 34-02: [specific next action]
```

---

## Deviation Rules (Auto-Applied During Execution)

1. **Auto-fix bugs**: If you discover bugs in FileOutputManager, fix them immediately
2. **Auto-add missing critical**: If you find security/correctness gaps, document them
3. **Auto-fix blockers**: If you hit impediments, resolve them and document
4. **Ask about architectural**: Major design decisions → stop and ask user
5. **Log enhancements**: Nice-to-have improvements → log to ISSUES.md

All deviations will be documented in SUMMARY.md.

---

## Quality Controls

### Verification Checklist
Before declaring this phase complete:
- [ ] FileOutputManager fully analyzed (Task 1)
- [ ] All 12 isInMainFile() sites documented (Task 2)
- [ ] FileOriginTracker design complete (Task 3)
- [ ] Multi-file test cases created (Task 4)
- [ ] FINDINGS.md exists with all required sections
- [ ] SUMMARY.md created with substantive content
- [ ] Recommendations for next phases clear and actionable

### Sources to Consult
1. `include/FileOutputManager.h` and `src/FileOutputManager.cpp`
2. `src/CppToCVisitor.cpp` (all isInMainFile() locations)
3. `include/IncludeGuardGenerator.h` and implementation
4. `.prompts/045-cpp23-gaps-analysis/cpp23-gaps-analysis.md`
5. Git history for isInMainFile() checks: `git log -p --all -S "isInMainFile()" src/CppToCVisitor.cpp`

---

**Ready to execute**: Use `/run-plan .planning/phases/34-header-file-skipping/34-01-PLAN.md`

**DO NOT** use this skill to execute - hand off to `/run-plan` command for context efficiency.
