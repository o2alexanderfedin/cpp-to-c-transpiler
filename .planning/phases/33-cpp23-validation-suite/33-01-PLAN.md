# Phase 33: C++23 Compiler Validation Suite Integration

## Executive Summary

**Objective**: Integrate comprehensive C++23 validation test projects to verify transpiler capabilities and establish A/B testing framework.

**Status**: PLANNED - Ready for implementation
**Priority**: HIGH - Critical for measuring transpiler completeness
**Estimated Effort**: 3-5 days (research complete, implementation pending)

---

## Background

### Current State
- **Existing Validation**: We have `tests/real-world/cpp23-validation/` with 6 C++23 features
- **Current Coverage**: Basic tests for deducing this, if consteval, multidimensional subscript, static operators, attributes, literals
- **Known Issues**: Per README.md, transpiler outputs C++ code, not C99 - transpilation incomplete
- **Current Status**: All features marked as "‚ùå Not transpiled" or "‚ö†Ô∏è Unknown"

### Research Findings
Completed comprehensive research identifying 5 candidate projects (see agent adbd0a9 research):
1. **GCC Test Suite** (261 C++23 tests) - Score: 9/10
2. **scivision/Cpp23-examples** (MIT, small) - Score: 8/10
3. **MSVC STL** (library features) - Score: 6/10
4. **Apress/beginning-cpp23** (educational) - Score: 7/10
5. **LLVM libc++** (library features) - Score: 7/10

---

## Problem Statement

### What We Need
1. **Comprehensive Test Coverage**: 261 GCC tests vs our current 6 tests
2. **Language vs Library Separation**: Focus on language features first (we don't transpile STL)
3. **A/B Testing Framework**: Automated validation that C++ ‚Üí C transpilation works correctly
4. **Feature Gap Analysis**: Understand which C++23 features we support/don't support

### Constraints
- **License Compatibility**: Must use MIT/Apache-2.0/BSD licensed projects
- **Size Management**: Don't bloat repository with massive test suites (selective extraction)
- **Integration Effort**: Minimize adaptation work (prefer projects ready to use)
- **Existing Work**: Build on existing `cpp23-validation/` directory

---

## Objectives

### Primary Goals
1. ‚úÖ Integrate GCC C++23 test suite (language features only)
2. ‚úÖ Add scivision/Cpp23-examples as reference project
3. ‚úÖ Create A/B testing framework for transpilation validation
4. ‚úÖ Document supported vs unsupported C++23 features
5. ‚úÖ Establish baseline metrics (% of C++23 features working)

### Secondary Goals
6. ‚è∏Ô∏è Reference MSVC/LLVM library tests (future STL transpilation)
7. ‚è∏Ô∏è Create C++23 feature detection system
8. ‚è∏Ô∏è Generate compliance report card

---

## Solution Design

### Architecture Overview

```
tests/real-world/cpp23-validation/
‚îú‚îÄ‚îÄ external-projects/          # Git submodules (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ gcc-testsuite/         # GCC g++.dg/cpp23 (extracted)
‚îÇ   ‚îî‚îÄ‚îÄ cpp23-examples/        # scivision/Cpp23-examples
‚îú‚îÄ‚îÄ cpp/                       # Our curated C++23 tests (EXISTING)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ include/
‚îÇ   ‚îî‚îÄ‚îÄ CMakeLists.txt
‚îú‚îÄ‚îÄ gcc-tests/                 # Adapted GCC tests (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ deducing-this/
‚îÇ   ‚îú‚îÄ‚îÄ if-consteval/
‚îÇ   ‚îú‚îÄ‚îÄ multidim-subscript/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ transpiled/                # Generated C code (EXISTING)
‚îú‚îÄ‚îÄ ab-test/                   # A/B testing framework (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ run-tests.sh          # Main test runner
‚îÇ   ‚îú‚îÄ‚îÄ compare.py            # C++ vs C output comparison
‚îÇ   ‚îî‚îÄ‚îÄ results/              # Test results
‚îú‚îÄ‚îÄ docs/                      # Documentation (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ FEATURE-MATRIX.md     # Supported features matrix
‚îÇ   ‚îú‚îÄ‚îÄ GAPS.md               # Known limitations
‚îÇ   ‚îî‚îÄ‚îÄ INTEGRATION.md        # Integration guide
‚îî‚îÄ‚îÄ scripts/                   # Automation (NEW)
    ‚îú‚îÄ‚îÄ import-gcc-tests.sh   # Extract GCC tests
    ‚îú‚îÄ‚îÄ transpile-all.sh      # Transpile all tests
    ‚îî‚îÄ‚îÄ generate-report.sh    # Generate compliance report
```

### Integration Strategy

#### Phase 33.1: Setup External Projects (1 day)
**Goal**: Add external test sources as git submodules

**Tasks**:
1. Add scivision/Cpp23-examples as git submodule
   ```bash
   cd tests/real-world/cpp23-validation
   mkdir -p external-projects
   git submodule add https://github.com/scivision/Cpp23-examples.git external-projects/cpp23-examples
   ```

2. Extract GCC g++.dg/cpp23 tests (selective)
   - Clone GCC mirror temporarily
   - Extract `gcc/testsuite/g++.dg/cpp23/` directory
   - Filter to keep only .C test files (ignore directives)
   - Document source commit hash
   - Add as tarball or selective copy (not full submodule - too large)

3. Document licenses and attributions
   - Create LICENSES.md with all source attributions
   - Verify GPL compatibility with our project

**Deliverables**:
- [ ] `external-projects/cpp23-examples/` (git submodule)
- [ ] `external-projects/gcc-tests/` (extracted, documented)
- [ ] `LICENSES.md` with full attributions

---

#### Phase 33.2: GCC Test Adaptation (2 days)
**Goal**: Convert GCC tests to standalone C++ files

**Tasks**:
1. Create adaptation framework
   ```python
   # scripts/adapt-gcc-test.py
   def adapt_gcc_test(input_file):
       """
       Strip GCC-specific directives:
       - { dg-do compile }
       - { dg-options "-std=c++23" }
       - { dg-error, dg-warning, etc.

       Extract actual C++ code
       Wrap in proper headers/main if needed
       """
   ```

2. Organize by feature (following GCC structure)
   ```
   gcc-tests/
   ‚îú‚îÄ‚îÄ deducing-this/       (~60 tests)
   ‚îú‚îÄ‚îÄ if-consteval/        (~13 tests)
   ‚îú‚îÄ‚îÄ multidim-subscript/  (~15 tests)
   ‚îú‚îÄ‚îÄ static-operators/    (~8 tests)
   ‚îú‚îÄ‚îÄ auto-decay/          (~18 tests)
   ‚îî‚îÄ‚îÄ constexpr-cpp23/     (~19 tests)
   ```

3. Create CMakeLists.txt for each feature set
   - One executable per feature directory
   - Can build and run in C++23 mode
   - Produces known-good output for A/B testing

**Deliverables**:
- [ ] `scripts/adapt-gcc-test.py` (adaptation tool)
- [ ] `gcc-tests/*/CMakeLists.txt` (build files)
- [ ] ~130 adapted test files (focus on top 6 features)
- [ ] `gcc-tests/README.md` (documentation)

---

#### Phase 33.3: A/B Testing Framework (1 day)
**Goal**: Automated validation that C++ ‚Üí C transpilation produces correct output

**Design**:
```bash
# ab-test/run-tests.sh
for test_dir in gcc-tests/*/; do
    feature=$(basename $test_dir)

    # 1. Build C++ version
    cd $test_dir && cmake . && make
    ./test_$feature > ../ab-test/results/$feature.cpp.out

    # 2. Transpile to C
    ../../scripts/transpile-all.sh $test_dir

    # 3. Build C version (if transpilation succeeded)
    cd transpiled/$feature
    make > ../ab-test/results/$feature.c.build.log 2>&1

    # 4. Run C version
    ./test_$feature > ../../ab-test/results/$feature.c.out

    # 5. Compare outputs
    python3 ../../ab-test/compare.py \
        ../results/$feature.cpp.out \
        ../results/$feature.c.out \
        > ../results/$feature.diff

    # 6. Record result
    if [ $? -eq 0 ]; then
        echo "‚úÖ $feature PASSED" >> ../results/summary.txt
    else
        echo "‚ùå $feature FAILED" >> ../results/summary.txt
    fi
done
```

**Validation Levels**:
1. **Build Success**: Does transpiled C code compile?
2. **Output Match**: Does C version produce same output as C++?
3. **Performance**: Is C version performant? (optional)

**Deliverables**:
- [ ] `ab-test/run-tests.sh` (main test runner)
- [ ] `ab-test/compare.py` (output comparison tool)
- [ ] `ab-test/validate-c-code.py` (C syntax validator)
- [ ] `ab-test/generate-report.py` (HTML/Markdown report generator)

---

#### Phase 33.4: Feature Matrix Documentation (0.5 days)
**Goal**: Clear documentation of supported/unsupported features

**Structure**:
```markdown
# C++23 Feature Support Matrix

## Legend
- ‚úÖ SUPPORTED: Transpiles correctly, A/B test passes
- ‚ö†Ô∏è PARTIAL: Transpiles but with limitations
- ‚ùå UNSUPPORTED: Does not transpile or fails
- üîß IN PROGRESS: Implementation underway
- üìã PLANNED: On roadmap

## Language Features

| Feature | Status | Tests | Notes |
|---------|--------|-------|-------|
| Deducing this (P0847) | ‚ùå | 0/60 | Requires explicit object params |
| if consteval (P1938) | ‚ùå | 0/13 | Needs compile-time evaluation |
| Multidim subscript (P2128) | ‚ùå | 0/15 | operator[] variadic args |
| Static operators (P1169) | ‚ùå | 0/8 | Static member operators |
| auto(x)/auto{x} (P0849) | ‚ö†Ô∏è | ?/18 | May work with type inference |
| ...| ... | ... | ... |

## By Feature Category

### ‚úÖ Core Language (Working)
- Basic classes ‚Üí structs
- Virtual functions ‚Üí vtables
- Templates ‚Üí monomorphization (partial)
- Inheritance ‚Üí composition (partial)

### ‚ùå Advanced Language (Not Working)
- Concepts
- Coroutines
- Modules
- Explicit object parameters (deducing this)
- consteval/constexpr compile-time execution

### üìã Standard Library (Planned)
- std::expected
- std::mdspan
- Ranges (v2)
- Format library
```

**Deliverables**:
- [ ] `docs/FEATURE-MATRIX.md`
- [ ] `docs/GAPS.md` (known limitations)
- [ ] `docs/ROADMAP.md` (future support plans)

---

#### Phase 33.5: Baseline Metrics (0.5 days)
**Goal**: Establish measurable compliance metrics

**Metrics to Track**:
```python
{
    "total_cpp23_features": 261,  # From GCC test suite
    "features_tested": 130,        # Subset we're testing
    "features_passing": 12,        # A/B tests passing
    "pass_rate": "9.2%",           # 12/130

    "by_category": {
        "deducing_this": {"total": 60, "passing": 0, "rate": "0%"},
        "if_consteval": {"total": 13, "passing": 0, "rate": "0%"},
        "multidim_subscript": {"total": 15, "passing": 0, "rate": "0%"},
        # ...
    },

    "build_success_rate": "45%",   # C code compiles
    "output_match_rate": "9.2%",   # C output matches C++

    "lines_of_code": {
        "cpp_input": 15000,
        "c_output": 18500,
        "expansion_ratio": 1.23
    }
}
```

**Reporting**:
- Generate JSON metrics file
- Create Markdown/HTML report card
- Track metrics over time (git commit each run)
- Badge system (shields.io) for README

**Deliverables**:
- [ ] `scripts/generate-metrics.py`
- [ ] `results/baseline-metrics.json`
- [ ] `results/compliance-report.html`

---

## Implementation Plan

### Timeline (5 days total)

#### Day 1: External Projects Setup
- Morning: Add scivision/Cpp23-examples submodule
- Afternoon: Extract GCC tests, create LICENSES.md

#### Day 2: GCC Test Adaptation
- Morning: Build adaptation scripts
- Afternoon: Adapt deducing-this tests (60 files)

#### Day 3: More GCC Test Adaptation
- Morning: Adapt if-consteval, multidim-subscript
- Afternoon: Adapt static-operators, auto-decay

#### Day 4: A/B Testing Framework
- Morning: Build test runner, comparison tools
- Afternoon: Run initial test suite, debug failures

#### Day 5: Documentation & Metrics
- Morning: Write feature matrix, gaps documentation
- Afternoon: Generate baseline metrics, compliance report

---

## Success Criteria

### Must Have ‚úÖ
1. [ ] At least 100 GCC tests integrated and adapted
2. [ ] A/B test framework runs end-to-end
3. [ ] Baseline metrics generated (current state)
4. [ ] Feature matrix documented
5. [ ] All changes committed with proper attribution

### Should Have ‚≠ê
6. [ ] scivision/Cpp23-examples integrated as reference
7. [ ] Automated test runner (scripts/transpile-all.sh)
8. [ ] HTML compliance report

### Nice to Have üíé
9. [ ] CI/CD integration (run A/B tests on every commit)
10. [ ] Performance benchmarks (C vs C++ speed)
11. [ ] Coverage badges for README

---

## Risks & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| GCC tests too complex to adapt | HIGH | MEDIUM | Start with simplest tests, document adaptation failures |
| GPL license conflicts | HIGH | LOW | Only extract test code (fair use), document sources |
| A/B tests all fail (transpiler incomplete) | MEDIUM | HIGH | Expected - document gaps, set realistic baseline |
| Excessive repository bloat | MEDIUM | MEDIUM | Use selective extraction, git-lfs for large files |
| Time overrun | LOW | MEDIUM | Phase deliverables allow incremental progress |

---

## Dependencies

### Technical Dependencies
- **Git submodules**: For external projects
- **Python 3.8+**: For automation scripts
- **CMake 3.20+**: For building tests
- **GCC 13+ or Clang 16+**: For C++23 support
- **C99 compiler**: For transpiled code validation

### Project Dependencies
- Existing transpiler implementation
- `tests/real-world/cpp23-validation/` directory
- Template monomorphization (Phase 32)
- Header separation (Phase 28)

---

## Future Enhancements

### Phase 33.6: STL Validation (Future)
- Integrate MSVC/LLVM library tests
- Validate std::expected, std::mdspan transpilation
- A/B test library features

### Phase 33.7: Continuous Integration
- GitHub Actions workflow
- Nightly compliance testing
- Automated PR validation

### Phase 33.8: Community Contributions
- Contribution guide for adding new C++23 tests
- Test template generator
- Feature request tracking

---

## References

### Research Documents
- [GCC C++23 Test Suite](https://github.com/gcc-mirror/gcc/tree/master/gcc/testsuite/g++.dg/cpp23)
- [scivision/Cpp23-examples](https://github.com/scivision/Cpp23-examples)
- [GCC C++ Status](https://gcc.gnu.org/projects/cxx-status.html)
- [Clang C++ Status](https://clang.llvm.org/cxx_status.html)

### Internal Documents
- Phase 32: Transpiler Architecture Fix
- Phase 28: Header File Generation
- Existing: `tests/real-world/cpp23-validation/README.md`

### Standards
- [ISO C++23 Standard (N4950)](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2023/n4950.pdf)
- [C++23 Feature List](https://en.cppreference.com/w/cpp/23)

---

## Notes

### Key Insights from Research
1. **GCC has 261 C++23 tests** - most comprehensive source
2. **scivision project is MIT licensed** - easy to integrate
3. **Current transpiler incomplete** - per existing README, outputs C++ not C
4. **Focus on language features** - library features require STL transpilation

### Assumptions
1. We can adapt GCC tests under fair use (test code, not implementation)
2. Current transpiler can be incrementally improved
3. A/B testing will show low initial pass rate (expected)
4. Documentation of gaps is as valuable as fixing them

### Open Questions
1. Should we integrate full 261 tests or subset (100-130)?
   - **Recommendation**: Start with 100-130 most relevant tests
2. Git submodule vs copy for GCC tests?
   - **Recommendation**: Copy/extract (GCC repo too large)
3. Priority order for feature implementation?
   - **Recommendation**: Start with features closest to working (auto-decay, templates)

---

## Approval & Sign-off

**Plan Status**: ‚úÖ READY FOR IMPLEMENTATION
**Estimated Effort**: 3-5 days
**Priority**: HIGH
**Next Step**: Begin Phase 33.1 (External Projects Setup)

---

**Document Version**: 1.0
**Created**: 2025-12-24
**Last Updated**: 2025-12-24
**Author**: Claude Sonnet 4.5 (Autonomous Mode)
**Research Agent**: adbd0a9
