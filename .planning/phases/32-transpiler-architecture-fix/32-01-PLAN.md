# Phase 32-01: Fix Transpiler Architecture - Use C AST for Output Generation

## Objective

**Fix critical transpiler bug where C AST nodes are built but never used for output generation, causing C++ syntax to appear in generated C code.**

**Impact**: This bug prevents ALL modern C++ features from transpiling correctly. Fixing it will enable C++11/14/17/20/23 features to generate valid C99 code.

**Root Cause**: The transpiler builds C AST nodes via CppToCVisitor but prints from the original C++ AST instead of the generated C AST, resulting in C++ syntax (namespace, class, template, constexpr) appearing in `.c` output files.

## Context

### Current Architecture (BROKEN)
```
C++ AST → CppToCVisitor builds C AST → [C AST STORED IN MAPS]
                                     → [NEVER RETRIEVED]
C++ AST → CodeGenerator.printDecl() → C++ syntax in .c files ❌
```

### Target Architecture (FIXED)
```
C++ AST → CppToCVisitor builds C AST → C TranslationUnit populated
                                     → CodeGenerator.printDecl(C AST)
                                     → Valid C99 code ✅
```

### Evidence of Bug

**File**: `src/CppToCConsumer.cpp:85-89`
```cpp
for (auto *D : TU->decls()) {  // TU is C++ TranslationUnitDecl!
  implGen.printDecl(D, false);  // Prints C++ Decl*, not C Decl*
}
```

**File**: `src/CppToCVisitor.cpp:147`
```cpp
cppToCMap[D] = CStruct;  // C struct created but only stored in map
```

**No code retrieves from `cppToCMap` for printing.**

### Files Involved

**Read**: @src/CppToCVisitor.cpp @include/CppToCVisitor.h @src/CppToCConsumer.cpp @src/CodeGenerator.cpp @src/CNodeBuilder.cpp @include/CNodeBuilder.h

**Write**: @src/CppToCVisitor.cpp @include/CppToCVisitor.h @src/CppToCConsumer.cpp

## Tasks

### Task 1: Add C TranslationUnit Infrastructure
**Type**: code
**Files**: `include/CppToCVisitor.h`, `src/CppToCVisitor.cpp`

**Action**:
1. Add member variable to CppToCVisitor:
```cpp
// In include/CppToCVisitor.h (after line 78)
// C TranslationUnit for generated code
clang::TranslationUnitDecl* C_TranslationUnit;
```

2. Initialize in constructor:
```cpp
// In src/CppToCVisitor.cpp constructor (after line 100)
// Create C TranslationUnit for output
C_TranslationUnit = clang::TranslationUnitDecl::Create(
    Context,
    &Context.Idents.get("_c_output"));
```

3. Add getter method:
```cpp
// In include/CppToCVisitor.h public methods
/**
 * @brief Get the C TranslationUnit containing generated C AST nodes
 * @return Pointer to C TranslationUnitDecl
 */
clang::TranslationUnitDecl* getCTranslationUnit() const {
    return C_TranslationUnit;
}
```

**Verify**:
- [ ] CppToCVisitor.h compiles
- [ ] CppToCVisitor.cpp compiles
- [ ] `getCTranslationUnit()` returns valid pointer
- [ ] No segfaults on initialization

**Done when**: C TranslationUnit member exists and is initialized

---

### Task 2: Populate C TranslationUnit with Generated Nodes
**Type**: code
**Files**: `src/CppToCVisitor.cpp`

**Action**:
1. After creating C struct (line 147), add to C TU:
```cpp
// After: cppToCMap[D] = CStruct;
C_TranslationUnit->addDecl(CStruct);
```

2. After creating C functions for methods (locate all `methodToCFunc[Method] = CFuncDecl`):
```cpp
// After each: methodToCFunc[Method] = CFuncDecl;
C_TranslationUnit->addDecl(CFuncDecl);
```

3. After creating constructor functions (locate all `ctorMap[Ctor] = CCtorFunc`):
```cpp
// After each: ctorMap[Ctor] = CCtorFunc;
C_TranslationUnit->addDecl(CCtorFunc);
```

4. After creating destructor functions (locate all `dtorMap[Dtor] = CDtorFunc`):
```cpp
// After each: dtorMap[Dtor] = CDtorFunc;
C_TranslationUnit->addDecl(CDtorFunc);
```

5. After creating standalone functions (locate all `standaloneFuncMap[mangledName] = CFuncDecl`):
```cpp
// After each: standaloneFuncMap[mangledName] = CFuncDecl;
C_TranslationUnit->addDecl(CFuncDecl);
```

6. Template monomorphizations (in `processTemplateInstantiations()`):
```cpp
// After generating each monomorphized struct/function:
// (locate template code generation, add to C_TU)
C_TranslationUnit->addDecl(GeneratedDecl);
```

**Verify**:
- [ ] All C AST nodes added to C_TranslationUnit
- [ ] No duplicate declarations
- [ ] Nodes accessible via `C_TranslationUnit->decls()`
- [ ] Count of C decls matches count of C++ decls processed

**Done when**: C TranslationUnit populated with all generated C AST nodes

---

### Task 3: Route Printer to C TranslationUnit
**Type**: code
**Files**: `src/CppToCConsumer.cpp`

**Action**:
1. Get C TranslationUnit from visitor:
```cpp
// After line 38: Visitor.TraverseDecl(TU);
// Get C TranslationUnit instead of printing C++ TU
clang::TranslationUnitDecl* C_TU = Visitor.getCTranslationUnit();
```

2. Replace printing loops to use C_TU:
```cpp
// Replace lines 57-61 (header generation):
for (auto *D : C_TU->decls()) {  // Changed from TU->decls()
  if (!D->isImplicit()) {
    headerGen.printDecl(D, true);
  }
}

// Replace lines 85-89 (impl generation):
for (auto *D : C_TU->decls()) {  // Changed from TU->decls()
  if (!D->isImplicit()) {
    implGen.printDecl(D, false);
  }
}
```

3. Add fallback for unmapped nodes (OPTIONAL - for unsupported features):
```cpp
// After getting C_TU, check if empty:
if (std::distance(C_TU->decls().begin(), C_TU->decls().end()) == 0) {
    llvm::errs() << "Warning: No C AST nodes generated. "
                 << "Input may contain unsupported C++ features.\n";
    // Could fall back to C++ TU here, but better to fail explicitly
    return;
}
```

**Verify**:
- [ ] CodeGenerator receives C Decl* nodes, not C++ Decl* nodes
- [ ] Generated .c files contain only C syntax
- [ ] No C++ keywords (namespace, class, template) in output
- [ ] Structs, functions, variables all present

**Done when**: Printer operates on C AST instead of C++ AST

---

### Task 4: Handle Template Monomorphizations
**Type**: code
**Files**: `src/CppToCVisitor.cpp`

**Action**:
1. Locate `processTemplateInstantiations()` method
2. Find where monomorphized code is generated (strings or AST nodes)
3. If strings: Parse back to AST or refactor to generate AST directly
4. Add monomorphized declarations to C_TranslationUnit:
```cpp
// In processTemplateInstantiations():
for (auto* ClassInst : m_templateExtractor->getClassInstantiations()) {
    std::string code = m_templateMonomorphizer->monomorphizeClass(ClassInst);

    // TODO: Currently generates strings, need AST nodes
    // For now, emit as comment or separate file
    // Future: Refactor TemplateMonomorphizer to return AST nodes
}
```

5. Short-term workaround: Keep template code as separate output
6. Long-term: Refactor TemplateMonomorphizer to build AST nodes

**Verify**:
- [ ] Template instantiations appear in output
- [ ] No template syntax in final C code
- [ ] Monomorphized names (e.g., `Container_int_ptr`) present

**Done when**: Template monomorphizations integrated with C AST output

---

### Task 5: Test with C++23 Validation Project
**Type**: verify
**Files**: Run existing C++23 validation test

**Action**:
1. Rebuild transpiler:
```bash
cd build_working
make -j$(sysctl -n hw.ncpu)
```

2. Run C++23 validation transpilation:
```bash
cd tests/real-world/cpp23-validation
./transpile.sh
```

3. Inspect generated C files:
```bash
# Check for C++ syntax (should be ZERO matches):
grep -r "namespace " transpiled/src/
grep -r "class " transpiled/src/
grep -r "template<" transpiled/src/
grep -r "constexpr " transpiled/src/

# Check for C syntax (should exist):
grep -r "typedef struct" transpiled/src/
grep -r "void.*(" transpiled/src/
```

4. Attempt C99 compilation:
```bash
cd transpiled
make clean
make
```

5. Document results:
- Number of files transpiled
- C++ syntax found (should be 0)
- C99 compilation success/failure
- Specific errors if any

**Verify**:
- [ ] No C++ syntax in generated .c files
- [ ] Valid C syntax present
- [ ] C99 compilation succeeds (or specific errors documented)
- [ ] Generated code structure matches input structure

**Done when**: C++23 validation shows significant improvement

---

### Task 6: Update Architecture Documentation
**Type**: docs
**Files**: `docs/ARCHITECTURE.md`, `.prompts/042-cpp23-to-c99-validation/SUMMARY.md`

**Action**:
1. Update `docs/ARCHITECTURE.md`:
   - Document C TranslationUnit creation
   - Explain AST node routing
   - Add diagram showing correct flow

2. Update `.prompts/042-cpp23-to-c99-validation/SUMMARY.md`:
   - Document bug fix
   - Update status of C++23 features
   - Revise estimated fix effort (completed)
   - Update recommendations

3. Create `.planning/phases/32-transpiler-architecture-fix/32-01-SUMMARY.md`:
   - Document what was fixed
   - Before/after comparison
   - Test results
   - Known limitations remaining

**Verify**:
- [ ] Architecture docs accurately reflect implementation
- [ ] Validation summary updated
- [ ] Phase summary complete

**Done when**: All documentation updated and accurate

---

## Verification Criteria

**Build verification**:
- [ ] All source files compile without errors
- [ ] All source files compile without warnings
- [ ] Transpiler executable links successfully

**Functional verification**:
- [ ] C TranslationUnit created and populated
- [ ] Generated C files contain only C syntax
- [ ] No C++ keywords in output (namespace, class, template, constexpr)
- [ ] Structs, functions, variables all present
- [ ] C++23 validation project transpiles successfully

**Code quality verification**:
- [ ] No compiler warnings
- [ ] Code follows existing patterns
- [ ] No memory leaks (AST nodes owned by ASTContext)
- [ ] Error handling for empty C TU

**Regression verification**:
- [ ] Existing tests still pass
- [ ] Previously working features unchanged
- [ ] No new crashes or segfaults

## Success Criteria

**MANDATORY** - All must be true:
1. C TranslationUnit infrastructure implemented
2. All generated C AST nodes added to C_TU
3. Printer routes to C AST instead of C++ AST
4. Generated C files contain NO C++ syntax
5. C99 compilation succeeds for simple C++ programs
6. Documentation updated
7. All verification criteria passing

**STRETCH** (nice to have):
- Template monomorphizations fully integrated
- AB-tests passing for C++11 features
- Performance benchmarks documented

## Known Limitations

After this fix, the following will remain:

1. **C++23/20 specific features**: May still not transpile (deducing this, if consteval, etc.)
   - **Reason**: Require additional semantic transformations beyond AST routing
   - **Future work**: Implement feature-specific translators

2. **STL dependencies**: std::vector, std::expected, etc. not transpiled
   - **Reason**: Require STL header transpilation
   - **Future work**: Add STL support or provide C alternatives

3. **Template complexity**: Very complex templates may generate invalid C
   - **Reason**: TemplateMonomorphizer has incomplete member extraction
   - **Future work**: Complete template monomorphization implementation

4. **Function bodies**: Some function bodies may still be stripped
   - **Reason**: Unsupported syntax causes AST recovery
   - **Future work**: Add feature detection and better error messages

## Deviations Handling

**Embedded in plan** per autonomous mode:

1. **Auto-fix bugs**: If C AST creation fails → diagnose and fix immediately
2. **Auto-add missing critical**: If nodes missing from C_TU → add them immediately
3. **Auto-fix blockers**: If printer crashes → fix immediately
4. **Ask about architectural**: Major design changes → stop and ask user
5. **Log enhancements**: Nice-to-haves → log to ISSUES.md

All deviations documented in SUMMARY.md.

## Estimated Effort

**Total time**: 4-6 hours

- Task 1 (Infrastructure): 45 minutes
- Task 2 (Populate C TU): 2 hours
- Task 3 (Route printer): 30 minutes
- Task 4 (Templates): 1 hour
- Task 5 (Testing): 1 hour
- Task 6 (Docs): 30 minutes

## Output

Create `.planning/phases/32-transpiler-architecture-fix/32-01-SUMMARY.md` with:

```markdown
# Phase 32-01: Transpiler Architecture Fix - SUMMARY

**Status**: ✅ COMPLETE / ⚠️ PARTIAL / ❌ FAILED

## What Was Fixed

- **Root cause**: C AST nodes built but never used for output
- **Solution**: Route CodeGenerator to C TranslationUnit
- **Impact**: [X] C++ features now transpile correctly

## Before/After Comparison

### Before (BROKEN)
- C++23 features: 0/8 transpiling
- C++ syntax in .c files: YES (namespace, class, template)
- C99 compilation: FAILED

### After (FIXED)
- C++23 features: [X]/8 transpiling
- C++ syntax in .c files: NO
- C99 compilation: [SUCCESS/PARTIAL/FAILED]

## Test Results

[Detailed test results from Task 5]

## Deviations from Plan

[List any bugs fixed, features added, blockers encountered]

## Known Issues Remaining

[List limitations that require future work]

## Next Steps

1. [Immediate follow-up work]
2. [Future enhancements]
3. [Additional testing needed]

---
*Completed*: [DATE]
*Effort*: [X] hours ([Y]% over/under estimate)
*Commit*: [HASH]
```

## Notes

- All AST nodes are owned by ASTContext (no manual memory management)
- C TranslationUnit is a regular Clang AST node (same as C++ TU)
- Existing mappings (cppToCMap) remain for lookup purposes
- CodeGenerator unchanged (still uses DeclPrinter/StmtPrinter)
- Only routing changes, not printer implementation
